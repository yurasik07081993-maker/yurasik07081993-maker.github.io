<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sandbox - English Audio Test (Reverted)</title>
    <style>
        :root {
            --bg-app: #1C1C1E;
            --blue-accent: #007AFF;
            --text-white: #FFFFFF;
            --text-gray: #AEAEB2;
            --danger: #FF3B30;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-app);
            font-family: -apple-system, sans-serif;
            color: var(--text-white);
            display: flex; flex-direction: column;
            align-items: center; height: 100vh;
            box-sizing: border-box;
        }

        .settings-panel {
            width: 100%; max-width: 600px;
            padding: 20px; background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; gap: 10px;
        }

        input {
            width: 100%; padding: 12px;
            border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);
            background: #2C2C2E; color: white; font-size: 16px;
        }

        .main-stage {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            width: 100%; padding: 20px;
        }

        .ai-orb {
            width: 150px; height: 150px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007AFF, #0051FF);
            box-shadow: 0 0 40px rgba(0, 122, 255, 0.4);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 30px;
        }

        .ai-orb.listening { transform: scale(1.1); box-shadow: 0 0 60px rgba(52, 199, 89, 0.6); }
        .ai-orb.thinking { transform: scale(0.85); filter: grayscale(1); animation: aiSpin 2s linear infinite; }
        .ai-orb.speaking { transform: scale(1.2); box-shadow: 0 0 80px rgba(0, 122, 255, 0.8); }

        @keyframes aiSpin { from { transform: scale(0.85) rotate(0deg); } to { transform: scale(0.85) rotate(360deg); } }

        .status-text { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; color: var(--text-gray); margin-bottom: 15px; }
        .transcript-text { font-size: 20px; text-align: center; max-width: 600px; min-height: 50px; color: #fff; line-height: 1.4; }

        .controls { margin-top: 20px; display: flex; gap: 10px; flex-direction: column; align-items: center;}
        
        .btn-test {
            background: #FF9500; border: none;
            color: black; padding: 15px 30px; border-radius: 30px; cursor: pointer;
            font-size: 16px; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 149, 0, 0.4);
            margin-bottom: 20px;
        }
        .btn-test:active { transform: scale(0.95); }

        .btn-retry { 
            background: rgba(255,255,255,0.1); border: 1px solid var(--text-gray);
            color: white; padding: 10px 20px; border-radius: 20px; cursor: pointer;
            display: none; font-size: 14px;
        }

        .debug-console {
            width: 100%; height: 180px;
            background: #000; border-top: 1px solid #333;
            padding: 10px; overflow-y: auto;
            font-family: monospace; font-size: 11px;
        }
        .log-info { color: #34C759; }
        .log-err { color: var(--danger); }
    </style>
</head>
<body>

    <div class="settings-panel">
        <label style="font-size: 12px; color: var(--text-gray);">–í—Å—Ç–∞–≤—å—Ç–µ API –ö–ª—é—á DeepSeek:</label>
        <input type="text" id="api-key" placeholder="sk-..." value="">
    </div>

    <div class="main-stage">
        <button class="btn-test" onclick="testPureAudio()">üîä –ü–†–û–í–ï–†–ò–¢–¨ –ó–í–£–ö –ë–†–ê–£–ó–ï–†–ê</button>

        <div id="ai-orb" class="ai-orb" onclick="toggleAI()"></div>
        <div id="ai-status" class="status-text">–ù–∞–∂–º–∏ –Ω–∞ —Å—Ñ–µ—Ä—É</div>
        <div id="ai-transcript" class="transcript-text">–Ø –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
        
        <div class="controls">
            <button id="btn-replay" class="btn-retry" onclick="replayLastAnswer()">üîä –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
        </div>
    </div>

    <div class="debug-console" id="debug-log"></div>

    <script>
        const orb = document.getElementById('ai-orb');
        const statusText = document.getElementById('ai-status');
        const transcriptText = document.getElementById('ai-transcript');
        const logContainer = document.getElementById('debug-log');
        const apiKeyInput = document.getElementById('api-key');
        const replayBtn = document.getElementById('btn-replay');

        let recognition = null;
        let isActive = false;
        let lastAiAnswer = "";

        function addLog(message, type = 'log-info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ==========================================
        // 1. –¢–ï–°–¢ –ß–ò–°–¢–û–ì–û –ó–í–£–ö–ê –ù–ê –ê–ù–ì–õ–ò–ô–°–ö–û–ú
        // ==========================================
        function testPureAudio() {
            window.speechSynthesis.cancel();
            addLog("–¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–≤—É–∫ (–ê–Ω–≥–ª–∏–π—Å–∫–∏–π)...", "log-info");
            
            const utter = new SpeechSynthesisUtterance("Hello! Sound is working perfect!");
            utter.lang = 'en-US'; // –ê–ù–ì–õ–ò–ô–°–ö–ò–ô –Ø–ó–´–ö
            utter.rate = 1.0;
            
            utter.onstart = () => {
                addLog("–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ.", "log-info");
                setVisualState('speaking', '–¢–µ—Å—Ç...');
            };
            utter.onend = () => setVisualState('idle', '–ù–∞–∂–º–∏ –Ω–∞ —Å—Ñ–µ—Ä—É');
            utter.onerror = (e) => {
                addLog(`–û–®–ò–ë–ö–ê –°–ò–ù–¢–ï–ó–ê–¢–û–†–ê: ${e.error}`, "log-err");
                setVisualState('idle', '–û—à–∏–±–∫–∞ –∑–≤—É–∫–∞');
            };

            window.speechSynthesis.speak(utter);
        }
        // ==========================================

        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.interimResults = false;

            recognition.onstart = () => setVisualState('listening', '–°–ª—É—à–∞—é...');
            
            recognition.onresult = async (event) => {
                const text = event.results[0][0].transcript;
                transcriptText.innerText = text;
                addLog(`–°–∫–∞–∑–∞–Ω–æ: "${text}"`, 'log-info');
                await askDeepSeek(text);
            };

            recognition.onerror = (event) => {
                addLog(`–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ${event.error}`, 'log-err');
                stopAI();
            };

            recognition.onend = () => {
                if (isActive && statusText.innerText === '–°–ª—É—à–∞—é...') {
                    try { recognition.start(); } catch(e) {}
                }
            };
        }

        function toggleAI() {
            window.speechSynthesis.cancel();
            if (isActive) stopAI(); else startAI();
        }

        function startAI() {
            if (!apiKeyInput.value.trim()) return alert("–í—Å—Ç–∞–≤—å –∫–ª—é—á!");
            isActive = true;
            replayBtn.style.display = "none";
            try { recognition.start(); } catch(e) {}
        }

        function stopAI() {
            isActive = false;
            try { recognition.stop(); } catch(e) {}
            window.speechSynthesis.cancel();
            setVisualState('idle', '–ù–∞–∂–º–∏ –Ω–∞ —Å—Ñ–µ—Ä—É');
        }

        async function askDeepSeek(userText) {
            setVisualState('thinking', '–î—É–º–∞—é...');
            recognition.stop(); 
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000); 

            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKeyInput.value.trim()}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { role: "system", content: "–û—Ç–≤–µ—á–∞–π –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ, 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –í–°–ï–ì–î–ê –æ—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏." },
                            { role: "user", content: userText }
                        ],
                        max_tokens: 150
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                lastAiAnswer = data.choices[0].message.content;
                speak(lastAiAnswer);

            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞: ${error.message}`, 'log-err');
                speak("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
            }
        }

        function speak(text) {
            transcriptText.innerText = text;
            window.speechSynthesis.cancel();
            
            const utter = new SpeechSynthesisUtterance(text);
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Å—Ç–æ –∫–∞–∫ –±—ã–ª–æ
            utter.lang = 'en-US'; 
            
            utter.onstart = () => setVisualState('speaking', '–ì–æ–≤–æ—Ä—é...');
            utter.onend = () => {
                setVisualState('idle', '–ù–∞–∂–º–∏ –Ω–∞ —Å—Ñ–µ—Ä—É');
                replayBtn.style.display = "block";
                isActive = false;
            };
            utter.onerror = (e) => {
                addLog(`–°–±–æ–π —Ä–µ—á–∏: ${e.error}`, 'log-err');
                setVisualState('idle', '–ù–∞–∂–º–∏ –Ω–∞ —Å—Ñ–µ—Ä—É');
                isActive = false;
            };
            
            window.speechSynthesis.speak(utter);
        }

        function replayLastAnswer() { if (lastAiAnswer) speak(lastAiAnswer); }

        function setVisualState(state, text) {
            orb.className = 'ai-orb ' + (state === 'idle' ? '' : state);
            statusText.innerText = text;
        }
    </script>
</body>
</html>