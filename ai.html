<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Voice Assistant - Infinity Mode</title>
    <style>
        :root {
            --bg-app: #1C1C1E;
            --blue-accent: #007AFF;
            --text-white: #FFFFFF;
            --text-gray: #AEAEB2;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-app);
            font-family: -apple-system, sans-serif;
            color: var(--text-white);
            display: flex; flex-direction: column;
            align-items: center; height: 100dvh;
            box-sizing: border-box;
            overflow: hidden;
        }

        .settings-panel {
            width: 100%; max-width: 600px;
            padding: 20px; background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        input {
            width: 100%; padding: 12px;
            border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);
            background: #2C2C2E; color: white; font-size: 16px;
            box-sizing: border-box;
        }

        .main-stage {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            width: 100%; padding: 20px;
        }

        .ai-orb {
            width: 160px; height: 160px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007AFF, #0051FF);
            box-shadow: 0 0 40px rgba(0, 122, 255, 0.4);
            transition: all 0.4s ease;
            cursor: pointer;
            margin-bottom: 30px;
        }

        .ai-orb.listening { transform: scale(1.1); box-shadow: 0 0 60px rgba(52, 199, 89, 0.6); }
        .ai-orb.thinking { transform: scale(0.85); filter: grayscale(1); animation: aiSpin 2s linear infinite; }
        .ai-orb.speaking { transform: scale(1.2); box-shadow: 0 0 80px rgba(0, 122, 255, 0.8); }

        @keyframes aiSpin { from { transform: scale(0.85) rotate(0deg); } to { transform: scale(0.85) rotate(360deg); } }

        .status-text { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 2px; color: var(--text-gray); margin-bottom: 15px; }
        .transcript-text { font-size: 20px; text-align: center; max-width: 600px; min-height: 50px; color: #fff; line-height: 1.4; }

        #debug-log {
            width: 100%; height: 100px;
            background: #000; border-top: 1px solid #333;
            padding: 10px; overflow-y: auto;
            font-family: monospace; font-size: 10px;
        }
        .log-info { color: #34C759; }
    </style>
</head>
<body>

    <div class="settings-panel">
        <input type="text" id="api-key" placeholder="Вставьте API Ключ DeepSeek">
    </div>

    <div class="main-stage">
        <div id="ai-orb" class="ai-orb" onclick="toggleAssistant()"></div>
        <div id="ai-status" class="status-text">Нажми чтобы начать</div>
        <div id="ai-transcript" class="transcript-text">Режим диалога выключен</div>
    </div>

    <div id="debug-log"></div>

    <script>
        const orb = document.getElementById('ai-orb');
        const statusText = document.getElementById('ai-status');
        const transcriptText = document.getElementById('ai-transcript');
        const apiKeyInput = document.getElementById('api-key');

        let recognition = null;
        let isAssistantActive = false; // Главный флаг работы
        let lastAiAnswer = "";

        function addLog(msg) {
            const div = document.createElement('div');
            div.className = 'log-info';
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('debug-log').appendChild(div);
        }

        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.interimResults = false;

            recognition.onstart = () => {
                if (!isAssistantActive) return;
                setVisualState('listening', 'Слушаю...');
            };

            recognition.onresult = async (event) => {
                if (!isAssistantActive) return;
                const text = event.results[0][0].transcript;
                transcriptText.innerText = "Вы: " + text;
                await askDeepSeek(text);
            };

            recognition.onerror = (event) => {
                if (isAssistantActive && event.error !== 'no-speech') {
                    addLog("Ошибка микрофона: " + event.error);
                }
            };

            recognition.onend = () => {
                // Если ассистент активен и сейчас не фаза обдумывания/речи - перезапускаем уши
                if (isAssistantActive && statusText.innerText === 'Слушаю...') {
                    try { recognition.start(); } catch(e) {}
                }
            };
        }

        function toggleAssistant() {
            if (isAssistantActive) {
                // ВЫКЛЮЧЕНИЕ
                isAssistantActive = false;
                window.speechSynthesis.cancel();
                try { recognition.stop(); } catch(e) {}
                setVisualState('idle', 'Нажми чтобы начать');
                transcriptText.innerText = "Пока!";
            } else {
                // ВКЛЮЧЕНИЕ
                if (!apiKeyInput.value.trim()) return alert("Вставь ключ!");
                isAssistantActive = true;
                
                // Прогрев звука
                window.speechSynthesis.speak(new SpeechSynthesisUtterance(''));
                
                startListening();
            }
        }

        function startListening() {
            if (!isAssistantActive) return;
            setVisualState('listening', 'Слушаю...');
            try { recognition.start(); } catch(e) {}
        }

        async function askDeepSeek(userText) {
            setVisualState('thinking', 'Думаю...');
            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKeyInput.value.trim()}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { role: "system", content: "Ты краткий голосовой помощник. Отвечай только на русском, очень коротко (1-2 предложения)." },
                            { role: "user", content: userText }
                        ]
                    })
                });

                const data = await response.json();
                const answer = data.choices[0].message.content;
                speak(answer);

            } catch (error) {
                addLog("Ошибка API");
                if (isAssistantActive) startListening();
            }
        }

        function speak(text) {
            if (!isAssistantActive) return;
            
            transcriptText.innerText = text;
            window.speechSynthesis.cancel();
            
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'ru-RU';
            
            utter.onstart = () => setVisualState('speaking', 'Говорю...');
            utter.onend = () => {
                if (isAssistantActive) {
                    // Как только закончил говорить - сразу включаем уши
                    setTimeout(() => startListening(), 300);
                }
            };
            
            window.speechSynthesis.speak(utter);
        }

        function setVisualState(state, text) {
            orb.className = 'ai-orb ' + (state === 'idle' ? '' : state);
            statusText.innerText = text;
        }
    </script>
</body>
</html>
