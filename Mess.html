<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mess P2P GitHub</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #007AFF; --primary-grad: linear-gradient(135deg, #007AFF 0%, #00C6FF 100%);
            --bg-color: #F2F2F7; --white: #ffffff; --my-bubble: #007AFF; --friend-bubble: #ffffff;
            --text-main: #000000; --text-sec: #8E8E93; --danger: #FF3B30; --success: #34C759;
            --shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); margin: 0; height: 100vh; display: flex; flex-direction: column;
            color: var(--text-main); overflow: hidden;
        }
        .screen { 
            padding: 20px; max-width: 600px; width: 100%; margin: 0 auto; 
            flex-grow: 1; display: flex; flex-direction: column; 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-color); z-index: 1;
        }
        .card { background: rgba(255, 255, 255, 0.9); border-radius: 20px; padding: 25px; box-shadow: var(--shadow); text-align: center; margin-bottom: 20px; }
        h2 { margin: 0 0 15px; font-weight: 700; font-size: 24px; }
        input[type="text"] { width: 100%; padding: 15px; border: none; border-radius: 14px; font-size: 16px; background: #E5E5EA; color: #000; margin-bottom: 15px; }
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 14px; background: var(--primary-grad); color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-small { padding: 8px 14px; border-radius: 15px; background: #E5E5EA; color: var(--primary); border: none; font-weight: 600; cursor: pointer; }
        
        .contact-list { list-style: none; padding: 0; margin: 10px 0; overflow-y: auto; max-height: 60vh; }
        .contact-item { background: #fff; padding: 14px; margin-bottom: 8px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; }
        .contact-avatar { width: 36px; height: 36px; background: var(--primary); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; margin-right: 10px; }

        #chat-screen { z-index: 2; background: #EFEFF4; } 
        .chat-header { padding: 10px 15px; background: rgba(255,255,255,0.95); border-bottom: 1px solid #ccc; z-index: 10; }
        .header-top { display: flex; align-items: center; justify-content: space-between; }
        .chat-title-box { display: flex; align-items: center; gap: 10px; }
        #chat-area { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; background: #E5E5EA; }
        
        .message-row { display: flex; margin-bottom: 8px; width: 100%; }
        .message-row.me { justify-content: flex-end; }
        .bubble { max-width: 80%; padding: 10px 14px; font-size: 16px; border-radius: 16px; position: relative; word-wrap: break-word; }
        .bubble.me { background: var(--my-bubble); color: white; border-bottom-right-radius: 4px; }
        .bubble.friend { background: var(--friend-bubble); color: black; border-bottom-left-radius: 4px; }
        .chat-img { border-radius: 12px; max-width: 100%; margin-top: 5px; }
        
        .input-area { padding: 10px; background: #fff; border-top: 1px solid #ccc; display: flex; gap: 8px; align-items: center; }
        #msg-input { flex-grow: 1; background: #F2F2F7; border-radius: 20px; padding: 10px 15px; border: 1px solid #ddd; }
        .icon-btn { width: 36px; height: 36px; border: none; background: transparent; font-size: 22px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        
        #emoji-picker { display: none; grid-template-columns: repeat(6, 1fr); gap: 5px; padding: 10px; background: #fff; height: 180px; overflow-y: auto; }
        .emoji-item { font-size: 24px; padding: 5px; cursor: pointer; }

        #call-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .call-btn { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 30px; margin: 0 20px; cursor: pointer; }
        .btn-answer { background: #34C759; color: white; }
        .btn-reject { background: #FF3B30; color: white; }
        
        .toast { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 2000; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>
    <audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <audio id="ringtone" src="https://assets.mixkit.co/active_storage/sfx/2865/2865-preview.mp3" loop></audio>
    <audio id="remote-audio" autoplay></audio>
    <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">

    <div id="call-overlay">
        <div style="font-size: 60px; margin-bottom: 20px;">üë§</div>
        <div id="call-status" style="font-size: 18px; margin-bottom: 10px;">–í—Ö–æ–¥—è—â–∏–π...</div>
        <div id="call-name" style="font-size: 30px; font-weight: bold; margin-bottom: 40px;">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π</div>
        <div id="incoming-controls" style="display:none;"><button class="call-btn btn-reject" onclick="rejectCall()">‚ùå</button><button class="call-btn btn-answer" onclick="answerCall()">üìû</button></div>
        <div id="ongoing-controls" style="display:none;"><button class="call-btn btn-reject" onclick="endCall()">üì¥</button></div>
    </div>

    <div id="login-screen" class="screen">
        <div style="flex-grow: 1; display: flex; align-items: center; justify-content: center;">
            <div class="card">
                <h2>Mess P2P</h2>
                <input type="text" id="my-name-input" placeholder="–í–∞—à–µ –∏–º—è">
                <input type="text" id="my-custom-id" placeholder="–í–∞—à ID">
                <button class="btn-main" onclick="initializePeer()">–í–æ–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <div id="connect-screen" class="screen" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>–ß–∞—Ç—ã</h1><button class="btn-small" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
        <div class="card">
            <div style="font-size: 12px; color: #888;">–í–ê–® ID</div>
            <h2 id="display-my-id" style="color: var(--primary);">...</h2>
            <button class="btn-small" onclick="shareId()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div style="margin-bottom: 20px;">
            <input type="text" id="friend-id-input" placeholder="ID –¥—Ä—É–≥–∞...">
            <div style="display: flex; gap: 10px;">
                <button id="connect-btn" class="btn-main" onclick="connectToFriend()">–ù–∞–ø–∏—Å–∞—Ç—å</button>
                <button id="wake-btn" class="btn-main" style="background: orange; display: none;" onclick="sendWakeUpNotification()">üîî –ü–æ–∑–≤–∞—Ç—å</button>
            </div>
        </div>
        <ul id="contacts-list" class="contact-list"></ul>
    </div>

    <div id="chat-screen" class="screen" style="display:none;">
        <div class="chat-header">
            <div class="header-top">
                <div class="chat-title-box">
                    <button class="icon-btn" style="font-size: 16px; width: auto;" onclick="backToContacts()">‚ùÆ –ù–∞–∑–∞–¥</button>
                    <div>
                        <div id="chat-title" style="font-weight: bold;">–ß–∞—Ç</div>
                        <div id="status-text" style="font-size: 11px; color: green;">–í —Å–µ—Ç–∏</div>
                    </div>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button class="icon-btn" onclick="startCall()">üìû</button>
                    <button class="icon-btn" onclick="clearHistory()" style="color: red;">üóëÔ∏è</button>
                </div>
            </div>
        </div>
        <div id="chat-area"></div>
        <div id="emoji-picker"></div>
        <div class="input-area">
            <button class="icon-btn" onclick="toggleEmoji()">üòÄ</button>
            <button class="icon-btn" onclick="triggerFilePicker()">üìé</button>
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" onkeypress="handleEnter(event)">
            <button id="mic-btn" class="icon-btn" onclick="toggleRecording()">üé§</button>
            <button class="icon-btn" style="color: var(--primary); font-size: 24px;" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <script>
        const peerConfig = { host: '0.peerjs.com', port: 443, secure: true, path: '/', debug: 1 };
        let peer, conn, myId="", currentFriendId="", mediaRecorder, audioChunks=[], activeCall=null, localStream=null;
        const emojis = ["üòÄ","üòÇ","üòç","ü•∫","üòé","üò≠","üëç","‚ù§Ô∏è","üî•","üéâ","üí©","ü§°","üëª","üëÄ","üëã","üíã","üåπ"];

        function initEmojis() {
            const p = document.getElementById('emoji-picker');
            emojis.forEach(e => {
                const s = document.createElement('span'); s.className='emoji-item'; s.innerText=e;
                s.onclick = () => document.getElementById('msg-input').value += e;
                p.appendChild(s);
            });
        }
        function toggleEmoji() { const p = document.getElementById('emoji-picker'); p.style.display = p.style.display==='grid'?'none':'grid'; }
        function triggerFilePicker() { document.getElementById('image-input').click(); }

        document.addEventListener('click', () => {
            const a = document.getElementById('msgSound'); if(a.paused){ a.volume=0; a.play().then(()=>{a.pause();a.volume=1;a.currentTime=0;}).catch(()=>{}); }
        }, {once:true});

        window.onload = function() {
            initEmojis();
            const n = localStorage.getItem('myName'), i = localStorage.getItem('myCustomId');
            if(n) document.getElementById('my-name-input').value = n;
            if(i) document.getElementById('my-custom-id').value = i;
            if(n && i) initializePeer(true);
            renderContacts();
        };

        function showScreen(id) {
            ['login-screen','connect-screen','chat-screen'].forEach(s => document.getElementById(s).style.display='none');
            document.getElementById(id).style.display = 'flex';
        }

        function initializePeer(auto=false) {
            const n = document.getElementById('my-name-input').value.trim();
            const i = document.getElementById('my-custom-id').value.trim().replace(/\s/g,'');
            if(!n || !i) return showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");
            localStorage.setItem('myName', n); localStorage.setItem('myCustomId', i);
            if(auto) { showScreen('connect-screen'); document.getElementById('display-my-id').innerText="..."; }
            else document.querySelector('#login-screen .btn-main').innerText="–í—Ö–æ–¥...";

            try { peer = new Peer(i, peerConfig); } catch(e){}
            peer.on('open', id => { myId=id; showScreen('connect-screen'); document.getElementById('display-my-id').innerText=id; });
            peer.on('error', e => { showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); showScreen('login-screen'); });
            peer.on('connection', c => { conn=c; setupConnection(); });
            peer.on('call', c => handleIncomingCall(c));
        }

        function connectToFriend() {
            const t = document.getElementById('friend-id-input').value.replace(/\s/g,'');
            if(!t) return showToast("–í–≤–µ–¥–∏—Ç–µ ID");
            const btn = document.getElementById('connect-btn'); btn.innerText="..."; btn.disabled=true;
            currentFriendId = t;
            try{ conn = peer.connect(t); } catch(e){}
            setTimeout(()=>{ if(!conn||!conn.open){ btn.innerText="–ù–µ—Ç —Å–µ—Ç–∏"; btn.disabled=false; document.getElementById('wake-btn').style.display='block'; } }, 4000);
            conn.on('open', ()=>{ btn.innerText="–ù–∞–ø–∏—Å–∞—Ç—å"; btn.disabled=false; setupUIForChat(); });
            setupConnection();
        }

        function setupConnection() {
            conn.on('open', ()=>setupUIForChat());
            conn.on('data', d => {
                if(d.type==='voice') addVoice(d.data,'friend',d.name,true);
                else if(d.type==='image') addImage(d.data,'friend',d.name,true);
                else if(d.text && d.type!=='call-notify') addMsg(d.text,'friend',d.name,true);
                if(d.type==='call-reject'||d.type==='call-end'){ closeCallUI(); showToast("–°–±—Ä–æ—Å"); }
                document.getElementById('msgSound').play().catch(()=>{});
            });
            conn.on('close', ()=>showToast("–í—ã—à–µ–ª"));
        }

        function setupUIForChat() {
            if(conn.peer) currentFriendId=conn.peer;
            document.getElementById('chat-title').innerText=currentFriendId;
            loadHistory(currentFriendId);
            showScreen('chat-screen');
        }
        function backToContacts() { showScreen('connect-screen'); if(conn) conn.close(); }
        function logout() { localStorage.clear(); location.reload(); }

        function sendMessage() {
            const inp = document.getElementById('msg-input'); const txt = inp.value.trim();
            if(!txt) return;
            const n = document.getElementById('my-name-input').value;
            if(conn&&conn.open) conn.send({text:txt, name:n, type:'text'});
            addMsg(txt,'me',n,true); inp.value=''; document.getElementById('emoji-picker').style.display='none';
        }

        function addMsg(t, type, n, s) { appendBubble(`<div class="bubble ${type}">${t}</div>`, type, s, {type:'text', text:t, sender:type, name:n}); }
        function addVoice(d, type, n, s) { appendBubble(`<div class="bubble ${type}">‚ñ∂Ô∏è <audio controls src="${d}"></audio></div>`, type, s, {type:'voice', data:d, sender:type, name:n}); }
        function addImage(d, type, n, s) { appendBubble(`<div class="bubble ${type}"><img src="${d}" class="chat-img" onclick="window.open(this.src)"></div>`, type, s, {type:'image', data:d, sender:type, name:n}); }
        
        function appendBubble(html, type, save, msgObj) {
            const div = document.createElement('div'); div.className=`message-row ${type}`; div.innerHTML=html;
            document.getElementById('chat-area').append(div);
            if(save) saveHist(currentFriendId, msgObj);
        }

        function saveHist(id, obj) { 
            let h = JSON.parse(localStorage.getItem('hist_'+id)||'[]'); h.push(obj); localStorage.setItem('hist_'+id, JSON.stringify(h)); 
        }
        function loadHistory(id) {
            document.getElementById('chat-area').innerHTML='';
            let h = JSON.parse(localStorage.getItem('hist_'+id)||'[]');
            h.forEach(m => {
                if(m.type==='text') addMsg(m.text, m.sender, m.name, false);
                else if(m.type==='voice') addVoice(m.data, m.sender, m.name, false);
                else if(m.type==='image') addImage(m.data, m.sender, m.name, false);
            });
        }
        function clearHistory() { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { localStorage.removeItem('hist_'+currentFriendId); loadHistory(currentFriendId); } }

        // Calls
        async function startCall() {
            if(!conn||!conn.open) return showToast("–ù–µ—Ç —Å–µ—Ç–∏");
            showCallUI(currentFriendId, "–ò—Å—Ö–æ–¥—è—â–∏–π...", false);
            try { localStream = await navigator.mediaDevices.getUserMedia({audio:true});
            const call = peer.call(currentFriendId, localStream); handleCall(call);
            conn.send({type:'call-notify', text:'–ó–≤–æ–Ω–æ–∫'}); } catch(e){ closeCallUI(); showToast("–ú–∏–∫—Ä–æ—Ñ–æ–Ω?"); }
        }
        function handleIncomingCall(call) { activeCall=call; document.getElementById('ringtone').play().catch(()=>{}); showCallUI(call.peer,"–í—Ö–æ–¥—è—â–∏–π...",true); }
        async function answerCall() {
            document.getElementById('ringtone').pause();
            try { localStream = await navigator.mediaDevices.getUserMedia({audio:true});
            activeCall.answer(localStream); handleCall(activeCall);
            document.getElementById('incoming-controls').style.display='none'; document.getElementById('ongoing-controls').style.display='flex';
            } catch(e){ endCall(); }
        }
        function rejectCall() { if(activeCall) activeCall.close(); closeCallUI(); if(conn) conn.send({type:'call-reject'}); }
        function endCall() { if(activeCall) activeCall.close(); closeCallUI(); if(conn) conn.send({type:'call-end'}); }
        function handleCall(call) {
            activeCall=call;
            call.on('stream', s => { document.getElementById('remote-audio').srcObject=s; });
            call.on('close', closeCallUI);
        }
        function showCallUI(n,s,inc) {
            document.getElementById('call-overlay').style.display='flex';
            document.getElementById('call-name').innerText=n; document.getElementById('call-status').innerText=s;
            document.getElementById('incoming-controls').style.display=inc?'block':'none';
            document.getElementById('ongoing-controls').style.display=inc?'none':'block';
        }
        function closeCallUI() {
            document.getElementById('call-overlay').style.display='none';
            document.getElementById('ringtone').pause(); document.getElementById('ringtone').currentTime=0;
            if(localStream) localStream.getTracks().forEach(t=>t.stop());
        }

        function handleImageUpload(inp) {
            const f = inp.files[0]; if(!f) return;
            const r = new FileReader(); r.onload=e=>{ 
                const d=e.target.result; if(conn) conn.send({type:'image', name:'Me', data:d}); addImage(d,'me','Me',true); 
            }; r.readAsDataURL(f); inp.value='';
        }
        async function toggleRecording() {
            const b = document.getElementById('mic-btn');
            if(!mediaRecorder || mediaRecorder.state==='inactive') {
                try { const s = await navigator.mediaDevices.getUserMedia({audio:true});
                mediaRecorder = new MediaRecorder(s); audioChunks=[];
                mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
                mediaRecorder.onstop=()=>{
                    const bl=new Blob(audioChunks,{type:'audio/webm'}); const r=new FileReader(); r.readAsDataURL(bl);
                    r.onloadend=()=>{ if(conn) conn.send({type:'voice',name:'Me',data:r.result}); addVoice(r.result,'me','Me',true); };
                }; mediaRecorder.start(); b.style.color='red'; } catch(e){ showToast("–ú–∏–∫—Ä–æ—Ñ–æ–Ω?"); }
            } else { mediaRecorder.stop(); b.style.color='black'; }
        }
        function handleEnter(e) { if(e.key==='Enter') sendMessage(); }
        function shareId() { navigator.clipboard.writeText(myId); showToast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"); }
        function sendWakeUpNotification() { navigator.clipboard.writeText(`Mess ID: ${myId}`); showToast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ"); }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
        function saveCurrentContact() { 
            let c=JSON.parse(localStorage.getItem('myContacts')||'[]'); 
            if(!c.some(x=>x.id===currentFriendId)) { c.push({name:currentFriendId, id:currentFriendId}); localStorage.setItem('myContacts',JSON.stringify(c)); renderContacts(); } 
        }
        function renderContacts() {
            const l=document.getElementById('contacts-list'); l.innerHTML='';
            JSON.parse(localStorage.getItem('myContacts')||'[]').forEach((c,i)=>{
                const li=document.createElement('li'); li.className='contact-item';
                li.innerHTML=`<div onclick="connectToFriend('${c.id}')" style="flex-grow:1">${c.name}</div><div onclick="deleteContact(${i})" style="color:red;padding:5px;">‚úï</div>`;
                l.appendChild(li);
            });
        }
        function deleteContact(i) { 
            let c=JSON.parse(localStorage.getItem('myContacts')||'[]'); c.splice(i,1); localStorage.setItem('myContacts',JSON.stringify(c)); renderContacts(); 
        }
    </script>
</body>
</html>
