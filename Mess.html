<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>P2P Chat 11.0 History</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --white: #ffffff;
            --text-dark: #2d3748;
            --text-light: #718096;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #e5ddd5;
            background-image: radial-gradient(#b0b3b5 1.5px, transparent 1.5px);
            background-size: 20px 20px;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-dark);
            overflow: hidden;
        }

        .screen { padding: 20px; max-width: 500px; width: 100%; margin: 0 auto; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 24px; padding: 25px; box-shadow: var(--shadow);
            text-align: center; margin-bottom: 20px;
        }

        h2 { margin: 0 0 10px; font-weight: 800; font-size: 24px; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-label { font-size: 12px; font-weight: bold; color: var(--text-light); margin-left: 10px; margin-bottom: 5px; display: block; }
        
        input[type="text"] {
            width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 16px; font-size: 16px; background: #f8fafc; transition: 0.3s;
        }
        input[type="text"]:focus { border-color: #667eea; background: #fff; }

        .btn-main {
            width: 100%; padding: 16px; border: none; border-radius: 16px; background: var(--primary-gradient); color: white; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; box-shadow: 0 4px 10px rgba(118, 75, 162, 0.3);
        }
        .btn-main:active { transform: scale(0.98); opacity: 0.9; }
        .btn-main:disabled { background: #cbd5e0; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-small { padding: 8px 15px; border-radius: 10px; background: #edf2f7; color: #4a5568; border: none; font-size: 13px; font-weight: 600; cursor: pointer; }
        
        #wake-btn { display: none; width: 100%; padding: 12px; border: none; border-radius: 16px; background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color: white; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-5px);} 60% {transform: translateY(-3px);} }

        .contact-list { list-style: none; padding: 0; margin: 10px 0; text-align: left; max-height: 200px; overflow-y: auto; }
        .contact-item { background: #fff; padding: 12px; margin-bottom: 8px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #edf2f7; cursor: pointer; }
        .contact-name { font-weight: bold; color: #4a5568; font-size: 14px; }
        .contact-id { font-size: 11px; color: #a0aec0; }
        .delete-contact { color: #e53e3e; font-size: 18px; padding: 0 10px; cursor: pointer; }

        #chat-screen { display: none; flex-direction: column; height: 100%; background: transparent; }
        
        .chat-header { padding: 10px 15px; background: rgba(255,255,255,0.95); border-bottom: 1px solid #edf2f7; display: flex; flex-direction: column; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header-top { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .volume-control { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #718096; background: #f7fafc; padding: 5px 10px; border-radius: 15px; width: fit-content; align-self: center; }
        input[type=range] { width: 80px; accent-color: #764ba2; }

        #chat-area { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        
        .message-row { display: flex; margin-bottom: 15px; width: 100%; }
        .message-row.me { justify-content: flex-end; }
        .bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; word-wrap: break-word;}
        .bubble.me { background: var(--primary-gradient); color: white; border-bottom-right-radius: 4px; }
        .bubble.friend { background: white; color: var(--text-dark); border-bottom-left-radius: 4px; }
        
        audio { height: 35px; width: 200px; margin-top: 5px; outline: none; }
        .bubble.me audio { filter: invert(1); }
        .chat-img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }

        .input-area { padding: 15px; background: white; border-top: 1px solid #edf2f7; display: flex; gap: 8px; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        #msg-input { flex-grow: 1; background: #f4f6f9; border: none; border-radius: 25px; padding: 12px 20px; }
        
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; flex-shrink: 0; background: #edf2f7; color: #4a5568; font-size: 18px; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.9); }
        .send-btn { background: var(--primary-gradient); color: white; width: 45px; height: 45px; font-size: 20px; }
        #mic-btn.recording { background: #e53e3e; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* –ó–í–û–ù–ö–ò */
        #call-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2d3436 0%, #000000 100%);
            z-index: 999; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        .call-avatar { width: 120px; height: 120px; background: #555; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; margin-bottom: 20px; border: 3px solid white; }
        .call-status { font-size: 18px; margin-bottom: 10px; color: #bbb; }
        .call-name { font-size: 32px; font-weight: bold; margin-bottom: 50px; }
        .call-controls { display: flex; gap: 40px; }
        .call-btn { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-answer { background: #2ecc71; color: white; animation: pulse 1s infinite; }
        .btn-reject { background: #e74c3c; color: white; }
        .phone-btn { background: #48bb78; color: white; }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #2d3748; color: white; padding: 10px 20px; border-radius: 30px; font-size: 14px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100; }
        .toast.show { opacity: 1; }
        
        /* –ö–ù–û–ü–ö–ê –£–î–ê–õ–ï–ù–ò–Ø –ò–°–¢–û–†–ò–ò */
        .trash-btn { color: #e53e3e; background: #fff5f5; }
    </style>
</head>
<body>
    <div id="toast" class="toast">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>
    <audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="ringtone" src="https://assets.mixkit.co/active_storage/sfx/2865/2865-preview.mp3" loop></audio>
    <audio id="remote-audio" autoplay></audio>
    <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">

    <div id="call-overlay">
        <div class="call-avatar">üë§</div>
        <div id="call-status" class="call-status">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...</div>
        <div id="call-name" class="call-name">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π</div>
        <div id="incoming-controls" class="call-controls" style="display:none;">
            <button class="call-btn btn-reject" onclick="rejectCall()">‚ùå</button>
            <button class="call-btn btn-answer" onclick="answerCall()">üìû</button>
        </div>
        <div id="ongoing-controls" class="call-controls" style="display:none;">
            <button class="call-btn btn-reject" onclick="endCall()">üì¥</button>
        </div>
    </div>

    <div id="login-screen" class="screen">
        <div class="card">
            <h2>–í—Ö–æ–¥</h2>
            <div class="input-group">
                <span class="input-label">–í–ê–®–ï –ò–ú–Ø</span>
                <input type="text" id="my-name-input" placeholder="–ò–º—è">
            </div>
            <div class="input-group">
                <span class="input-label">–ü–†–ò–î–£–ú–ê–ô–¢–ï ID</span>
                <input type="text" id="my-custom-id" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: boss123">
            </div>
            <button class="btn-main" onclick="initializePeer()">–°–æ–∑–¥–∞—Ç—å —Å–µ—Ç—å üåê</button>
        </div>
    </div>

    <div id="connect-screen" class="screen" style="display:none;">
        <div class="card">
            <h2 id="display-my-id" style="font-size: 18px;">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
            <button class="btn-small" onclick="shareId()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å ID</button>
            <div style="margin-top: 5px;">
                <button class="btn-small" style="color: #e53e3e; font-size: 10px;" onclick="logout()">–°–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
        </div>
        <div class="card">
            <div class="input-group">
                <span class="input-label">–ù–û–í–´–ô –ß–ê–¢</span>
                <input type="text" id="friend-id-input" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞">
            </div>
            <button id="connect-btn" class="btn-main" onclick="connectToFriend()">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button id="wake-btn" onclick="sendWakeUpNotification()">üîî –ü–æ–∑–≤–∞—Ç—å –¥—Ä—É–≥–∞</button>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            <span class="input-label">–ò–°–¢–û–†–ò–Ø –ß–ê–¢–û–í</span>
            <ul id="contacts-list" class="contact-list"></ul>
        </div>
    </div>

    <div id="chat-screen">
        <div class="chat-header">
            <div class="header-top">
                <div style="display: flex; align-items: center; gap: 10px;">
                     <button class="btn-small" onclick="backToContacts()">‚¨Ö</button>
                    <div>
                        <span id="chat-title" style="font-weight: bold; font-size: 14px;">–ß–∞—Ç</span>
                        <div id="status-text" style="font-size: 10px; color: #48bb78;">–û–Ω–ª–∞–π–Ω</div>
                    </div>
                </div>
                <div style="display: flex; gap: 5px;">
                    <button class="icon-btn phone-btn" style="width:35px; height:35px;" onclick="startCall()">üìû</button>
                    <button class="btn-small" onclick="saveCurrentContact()">üíæ</button>
                    <button class="btn-small trash-btn" onclick="clearHistory()">üóëÔ∏è</button>
                </div>
            </div>
            <div class="volume-control">
                <span>üîä</span>
                <input type="range" id="vol-slider" min="0" max="1" step="0.05" value="0.1" onchange="setVolume(this.value)">
            </div>
        </div>
        <div id="chat-area"></div>
        <div class="input-area">
            <button class="icon-btn" onclick="document.getElementById('image-input').click()">üìé</button>
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleEnter(event)">
            <button id="mic-btn" class="icon-btn" onclick="toggleRecording()">üé§</button>
            <button class="icon-btn send-btn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <script>
        const peerConfig = { host: '0.peerjs.com', port: 443, secure: true, path: '/', debug: 1 };
        let peer, conn, myId = "", currentFriendId = "";
        let mediaRecorder, audioChunks = [];
        let currentVolume = 0.1;
        let activeCall = null;
        let localStream = null;

        document.addEventListener('click', function() {
            const audio = document.getElementById('msgSound');
            if (audio.paused) { 
                audio.volume = 0.0; audio.play().then(() => { audio.pause(); audio.currentTime = 0; }).catch(e=>{}); 
            }
        }, { once: true });

        // === –ê–í–¢–û-–í–•–û–î –ò –ó–ê–ì–†–£–ó–ö–ê ===
        window.onload = function() {
            const savedName = localStorage.getItem('myName');
            const savedId = localStorage.getItem('myCustomId');
            const savedVol = localStorage.getItem('chatVolume');

            if(savedName) document.getElementById('my-name-input').value = savedName;
            if(savedId) document.getElementById('my-custom-id').value = savedId;
            if(savedVol) { currentVolume = parseFloat(savedVol); document.getElementById('vol-slider').value = currentVolume; }
            
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å, –°–†–ê–ó–£ –≤—Ö–æ–¥–∏–º
            if (savedName && savedId) {
                initializePeer(true); // true = –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥
            }
            
            renderContacts();
        };

        function setVolume(val) {
            currentVolume = parseFloat(val);
            localStorage.setItem('chatVolume', currentVolume);
            const audio = document.getElementById('msgSound'); audio.volume = currentVolume; audio.play().catch(()=>{});
        }
        function playSound() { 
            const audio = document.getElementById('msgSound'); audio.volume = currentVolume; audio.currentTime = 0; audio.play().catch(e=>{}); 
        }

        // === –ò–°–¢–û–†–ò–Ø –°–û–û–ë–©–ï–ù–ò–ô ===
        function saveMessageToHistory(friendId, msgObj) {
            try {
                let history = JSON.parse(localStorage.getItem('hist_' + friendId) || "[]");
                history.push(msgObj);
                localStorage.setItem('hist_' + friendId, JSON.stringify(history));
            } catch (e) {
                console.error("Storage full?", e);
            }
        }

        function loadHistory(friendId) {
            const chatArea = document.getElementById('chat-area');
            chatArea.innerHTML = ""; // –ß–∏—Å—Ç–∏–º –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
            let history = JSON.parse(localStorage.getItem('hist_' + friendId) || "[]");
            
            history.forEach(msg => {
                if (msg.type === 'text') addMessage(msg.text, msg.sender, msg.name, false);
                else if (msg.type === 'image') addImageToChat(msg.data, msg.sender, msg.name, false);
                else if (msg.type === 'voice') addVoiceToChat(msg.data, msg.sender, msg.name, false);
            });
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function clearHistory() {
            if(!currentFriendId) return;
            if(confirm("–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É —Å —ç—Ç–∏–º –∫–æ–Ω—Ç–∞–∫—Ç–æ–º?")) {
                localStorage.removeItem('hist_' + currentFriendId);
                document.getElementById('chat-area').innerHTML = "";
                showToast("–ò—Å—Ç–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞");
            }
        }

        // === PEER JS LOGIC ===
        function initializePeer(isAuto = false) {
            const name = document.getElementById('my-name-input').value.trim();
            const customId = document.getElementById('my-custom-id').value.trim().replace(/\s/g, '');
            if (!name || !customId) return showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");
            
            localStorage.setItem('myName', name);
            localStorage.setItem('myCustomId', customId);

            // –ï—Å–ª–∏ –∞–≤—Ç–æ-–≤—Ö–æ–¥, —Å–∫—Ä—ã–≤–∞–µ–º –ª–æ–≥–∏–Ω —Å—Ä–∞–∑—É
            if(isAuto) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('connect-screen').style.display = 'flex';
                document.getElementById('display-my-id').innerText = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";
            } else {
                document.querySelector('#login-screen .btn-main').innerText = "–í—Ö–æ–¥...";
            }

            try { peer = new Peer(customId, peerConfig); } catch (e) { }

            peer.on('open', function(id) {
                myId = id;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('connect-screen').style.display = 'flex';
                document.getElementById('display-my-id').innerText = id;
            });
            peer.on('error', err => { 
                showToast("–û—à–∏–±–∫–∞ ID"); 
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ-–≤—Ö–æ–¥–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ —ç–∫—Ä–∞–Ω –ª–æ–≥–∏–Ω–∞
                document.getElementById('connect-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                document.querySelector('#login-screen .btn-main').innerText = "–°–æ–∑–¥–∞—Ç—å —Å–µ—Ç—å üåê";
            });
            peer.on('connection', c => { conn = c; setupConnection(); });
            peer.on('call', (call) => { handleIncomingCall(call); });
        }

        function connectToFriend(savedId = null) {
            const inputId = document.getElementById('friend-id-input').value.replace(/\s/g, ''); 
            const targetId = savedId || inputId;
            if (!targetId) return showToast("–í–≤–µ–¥–∏—Ç–µ ID!");
            
            const btn = document.getElementById('connect-btn');
            const wakeBtn = document.getElementById('wake-btn');
            btn.innerText = "‚åõ –ü–æ–∏—Å–∫..."; btn.disabled = true;
            wakeBtn.style.display = "none";

            currentFriendId = targetId;
            try { conn = peer.connect(targetId); } catch(e) {}
            
            setTimeout(() => { 
                if (!conn || !conn.open) { 
                    btn.innerText = "‚ùå –ù–µ –≤ —Å–µ—Ç–∏"; btn.disabled = false; wakeBtn.style.display = "block"; showToast("–î—Ä—É–≥ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç.");
                } 
            }, 4000);

            conn.on('open', () => { 
                btn.innerText = "üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"; btn.disabled = false; wakeBtn.style.display = "none"; 
                setupUIForChat(); 
            });
            setupConnection();
        }

        function setupConnection() {
            conn.on('open', () => setupUIForChat());
            conn.on('data', function(data) {
                // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                if (data.type === 'voice') { 
                    addVoiceToChat(data.data, 'friend', data.name, true); playSound(); 
                } 
                else if (data.type === 'image') { 
                    addImageToChat(data.data, 'friend', data.name, true); playSound(); 
                } 
                else if (data.text) { 
                    if(data.type !== 'call-notify') {
                        addMessage(data.text, 'friend', data.name, true); 
                    }
                    playSound(); 
                }

                if (data.type === 'call-reject' || data.type === 'call-end') {
                    closeCallUI(); showToast("–ó–≤–æ–Ω–æ–∫ —Å–±—Ä–æ—à–µ–Ω");
                }
            });
            conn.on('close', () => { showToast("–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤—ã—à–µ–ª"); });
        }

        function setupUIForChat() {
            if(conn.peer) currentFriendId = conn.peer;
            document.getElementById('chat-title').innerText = currentFriendId;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º —ç–∫—Ä–∞–Ω–∞
            loadHistory(currentFriendId);
            
            document.getElementById('connect-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
        }

        function backToContacts() {
            document.getElementById('chat-screen').style.display = 'none';
            document.getElementById('connect-screen').style.display = 'flex';
            if(conn) conn.close(); // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ, —á—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ—Ç—å
        }

        function logout() {
            localStorage.removeItem('myName');
            localStorage.removeItem('myCustomId');
            location.reload();
        }

        // === –û–¢–ü–†–ê–í–ö–ê –ò –°–û–•–†–ê–ù–ï–ù–ò–ï ===
        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            const myName = document.getElementById('my-name-input').value;
            if (!text) return;
            
            // –ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º (–∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫ –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ)
            if (conn && conn.open) {
                conn.send({ text: text, name: myName, type: 'text' });
            } else {
                showToast("–û—Ñ–ª–∞–π–Ω: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –∏—Å—Ç–æ—Ä–∏—é");
            }
            // –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º —Å–µ–±–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
            addMessage(text, 'me', myName, true);
            input.value = '';
        }

        // –ü–∞—Ä–∞–º–µ—Ç—Ä save = true –∑–Ω–∞—á–∏—Ç "—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–∞–º—è—Ç—å". False –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏.
        function addMessage(text, type, senderName, save) {
            const chatArea = document.getElementById('chat-area');
            const row = document.createElement('div');
            row.className = `message-row ${type}`;
            row.innerHTML = `<div class="bubble ${type}">${text}</div>`;
            chatArea.appendChild(row);
            chatArea.scrollTop = chatArea.scrollHeight;
            if(save) saveMessageToHistory(currentFriendId, { type: 'text', text: text, sender: type, name: senderName });
        }

        function addVoiceToChat(base64, type, senderName, save) {
            const chatArea = document.getElementById('chat-area');
            const row = document.createElement('div');
            row.className = `message-row ${type}`;
            row.innerHTML = `<div class="bubble ${type}">üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ<br><audio controls src="${base64}"></audio></div>`;
            chatArea.appendChild(row);
            chatArea.scrollTop = chatArea.scrollHeight;
            if(save) saveMessageToHistory(currentFriendId, { type: 'voice', data: base64, sender: type, name: senderName });
        }

        function addImageToChat(base64, type, senderName, save) {
            const chatArea = document.getElementById('chat-area');
            const row = document.createElement('div');
            row.className = `message-row ${type}`;
            row.innerHTML = `<div class="bubble ${type}"><img src="${base64}" class="chat-img" onclick="openImage(this)"></div>`;
            chatArea.appendChild(row);
            chatArea.scrollTop = chatArea.scrollHeight;
            if(save) saveMessageToHistory(currentFriendId, { type: 'image', data: base64, sender: type, name: senderName });
        }

        // ... (–§—É–Ω–∫—Ü–∏–∏ –∑–≤–æ–Ω–∫–æ–≤ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏) ...
        async function startCall() {
            if (!conn || !conn.open) return showToast("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –¥—Ä—É–≥–æ–º!");
            showCallUI(currentFriendId, "–ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...", false);
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                const call = peer.call(currentFriendId, localStream);
                handleCallStream(call);
                conn.send({ type: 'call-notify', text: '–Ø –∑–≤–æ–Ω—é —Ç–µ–±–µ!' });
            } catch (err) { closeCallUI(); showToast("–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: " + err); }
        }
        function handleIncomingCall(call) {
            activeCall = call; document.getElementById('ringtone').play().catch(()=>{});
            showCallUI(call.peer, "–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...", true);
        }
        async function answerCall() {
            document.getElementById('ringtone').pause(); document.getElementById('ringtone').currentTime = 0;
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                activeCall.answer(localStream); handleCallStream(activeCall);
                document.getElementById('incoming-controls').style.display = 'none';
                document.getElementById('ongoing-controls').style.display = 'flex';
                document.getElementById('call-status').innerText = "–†–∞–∑–≥–æ–≤–æ—Ä";
            } catch (err) { endCall(); showToast("–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: " + err); }
        }
        function rejectCall() {
            document.getElementById('ringtone').pause(); document.getElementById('ringtone').currentTime = 0;
            if (activeCall) activeCall.close(); closeCallUI();
            if(conn && conn.open) conn.send({ type: 'call-reject' });
        }
        function endCall() {
            if (activeCall) activeCall.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            closeCallUI();
            if(conn && conn.open) conn.send({ type: 'call-end' });
        }
        function handleCallStream(call) {
            activeCall = call;
            call.on('stream', (remoteStream) => {
                const audioElem = document.getElementById('remote-audio'); audioElem.srcObject = remoteStream;
                document.getElementById('call-status').innerText = "–ò–¥–µ—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä üéôÔ∏è";
                document.getElementById('incoming-controls').style.display = 'none';
                document.getElementById('ongoing-controls').style.display = 'flex';
            });
            call.on('close', () => { closeCallUI(); showToast("–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω"); });
        }
        function showCallUI(name, status, isIncoming) {
            const overlay = document.getElementById('call-overlay');
            document.getElementById('call-name').innerText = name;
            document.getElementById('call-status').innerText = status;
            document.getElementById('incoming-controls').style.display = isIncoming ? 'flex' : 'none';
            document.getElementById('ongoing-controls').style.display = isIncoming ? 'none' : 'flex';
            overlay.style.display = 'flex';
        }
        function closeCallUI() {
            document.getElementById('call-overlay').style.display = 'none';
            document.getElementById('ringtone').pause(); document.getElementById('ringtone').currentTime = 0;
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            activeCall = null;
        }
        function sendWakeUpNotification() {
            if(!currentFriendId) return;
            const text = `üëã –ü—Ä–∏–≤–µ—Ç! –ó–∞—Ö–æ–¥–∏ –≤ –ß–∞—Ç. –ú–æ–π ID: ${myId}`;
            if (navigator.share) { navigator.share({ title: 'P2P Chat', text: text }).catch(() => {}); } 
            else { navigator.clipboard.writeText(text); alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"); }
        }
        function handleImageUpload(input) {
            const file = input.files[0]; if (!file) return;
            if (file.size > 5 * 1024 * 1024) { showToast("–§–æ—Ç–æ > 5–ú–±"); return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result; const myName = document.getElementById('my-name-input').value;
                if (conn && conn.open) conn.send({ type: 'image', name: myName, data: base64 });
                addImageToChat(base64, 'me', myName, true);
            };
            reader.readAsDataURL(file); input.value = '';
        }
        async function toggleRecording() {
            const btn = document.getElementById('mic-btn');
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader(); reader.readAsDataURL(audioBlob);
                        reader.onloadend = function() {
                             if (conn && conn.open) {
                                 const myName = document.getElementById('my-name-input').value;
                                 conn.send({ type: 'voice', name: myName, data: reader.result });
                             }
                             addVoiceToChat(reader.result, 'me', '–Ø', true);
                        }
                    };
                    mediaRecorder.start(); btn.classList.add('recording');
                } catch (err) { showToast("–ù–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞"); }
            } else { mediaRecorder.stop(); btn.classList.remove('recording'); }
        }
        function saveCurrentContact() {
            if (!currentFriendId) return;
            const name = prompt("–ò–º—è –∫–æ–Ω—Ç–∞–∫—Ç–∞?", currentFriendId); if (!name) return;
            let contacts = JSON.parse(localStorage.getItem('myContacts') || "[]");
            if(!contacts.some(c => c.id === currentFriendId)) {
                contacts.push({ name: name, id: currentFriendId });
                localStorage.setItem('myContacts', JSON.stringify(contacts));
                renderContacts();
            }
        }
        function renderContacts() {
            const list = document.getElementById('contacts-list');
            const contacts = JSON.parse(localStorage.getItem('myContacts') || "[]");
            list.innerHTML = "";
            contacts.forEach((c, index) => {
                const li = document.createElement('li'); li.className = 'contact-item';
                li.innerHTML = `<div onclick="connectToFriend('${c.id}')" style="width:100%"><div class="contact-name">${c.name}</div><div class="contact-id">${c.id}</div></div><div class="delete-contact" onclick="deleteContact(${index})">√ó</div>`;
                list.appendChild(li);
            });
        }
        function deleteContact(i) {
            let contacts = JSON.parse(localStorage.getItem('myContacts') || "[]");
            contacts.splice(i, 1); localStorage.setItem('myContacts', JSON.stringify(contacts)); renderContacts();
        }
        function openImage(img) { const win = window.open(""); win.document.write('<img src="' + img.src + '" style="width:100%">'); }
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }
        function shareId() { navigator.clipboard.writeText(myId); showToast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"); }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }
    </script>
</body>
</html>
