<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой P2P Мессенджер</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; background: #f9f9f9; }
        input { padding: 10px; width: 70%; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #chat-area { height: 300px; border: 1px solid #ddd; overflow-y: scroll; padding: 10px; background: white; margin-bottom: 10px; }
        .message { margin-bottom: 10px; padding: 8px; border-radius: 10px; max-width: 80%; }
        .my-msg { background: #dcf8c6; margin-left: auto; text-align: right; } /* Зеленые сообщения (мои) */
        .friend-msg { background: #e8e8e8; margin-right: auto; } /* Серые сообщения (друга) */
        #status { font-weight: bold; color: #666; }
    </style>
</head>
<body>

    <h2>P2P Чат (без сервера для данных)</h2>

    <div class="box">
        <p>Ваш ID (отправьте другу):</p>
        <h3 id="my-id">...получение ID...</h3>
        <p id="status">Статус: Ожидание подключения к сети...</p>
    </div>

    <div class="box" id="connect-box">
        <p>Вставьте ID друга:</p>
        <input type="text" id="friend-id-input" placeholder="Например: 12345-abcde...">
        <button onclick="connectToFriend()">Подключиться</button>
    </div>

    <div id="chat-box" style="display:none;">
        <div id="chat-area"></div>
        <input type="text" id="msg-input" placeholder="Введите сообщение...">
        <button onclick="sendMessage()">Отправить</button>
    </div>

    <script>
        // Инициализация (используем бесплатный облачный сервер PeerJS только для "рукопожатия")
        const peer = new Peer(); 
        let conn; // Здесь будет храниться соединение

        // 1. Когда мы получили свой ID от сети
        peer.on('open', function(id) {
            document.getElementById('my-id').innerText = id;
            document.getElementById('status').innerText = "Статус: Готов к соединению";
        });

        // 2. Если К НАМ кто-то подключился
        peer.on('connection', function(c) {
            conn = c;
            setupConnection();
            alert("Друг подключился к вам!");
        });

        // 3. Если МЫ подключаемся к кому-то
        function connectToFriend() {
            const friendId = document.getElementById('friend-id-input').value;
            if (!friendId) return alert("Введите ID друга!");
            
            conn = peer.connect(friendId);
            setupConnection();
        }

        // Настройка событий соединения (общая для обоих случаев)
        function setupConnection() {
            // Скрываем меню подключения, показываем чат
            document.getElementById('connect-box').style.display = 'none';
            document.getElementById('chat-box').style.display = 'block';
            document.getElementById('status').innerText = "Статус: Подключено напрямую!";

            // Когда приходят данные
            conn.on('data', function(data) {
                addMessage(data, 'friend-msg');
            });

            conn.on('open', function(){
                console.log("Канал открыт");
            });
        }

        // Отправка сообщения
        function sendMessage() {
            const msgInput = document.getElementById('msg-input');
            const msg = msgInput.value;
            if (!msg) return;

            if (conn && conn.open) {
                conn.send(msg); // Отправляем P2P
                addMessage(msg, 'my-msg'); // Показываем у себя
                msgInput.value = '';
            } else {
                alert("Соединение разорвано");
            }
        }

        // Функция рисования сообщения на экране
        function addMessage(text, className) {
            const chatArea = document.getElementById('chat-area');
            const div = document.createElement('div');
            div.className = `message ${className}`;
            div.innerText = text;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight; // Прокрутка вниз
        }
    </script>
</body>
</html>